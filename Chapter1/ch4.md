# 第4节：FAT32文件恢复实验

## 3.1 基于数据簇连续分配的文件恢复算法

算法步骤如下： 

- (1)确定被删除文件所在分区的引导扇区的位置。可以由主引导扇区中的分区表确定。

- (2)从引导扇区中读取“每扇区字节数”、“每簇扇区数”、“保留扇区数”、“FAT个数”和“每个FAT所占扇区数”的参数值。并计算根目录相对于引导扇区的起始位置(从0开始)。根目录相对起始位置 = 保留扇区数 + FAT个数 * 每个FAT所占扇区数。

- (3)根据被删除文件的文件路径，从根目录开始逐层往下遍历找到该文件所在目录的目录项集合，并遍历该目录项集合，找到文件名与被删除文件的文件名部分匹配，且后缀名一致的目录项。

- (4)从找到的目录项中读取偏移为1AH-1BH的两个字节，确定起始簇号的低位字。读取偏移为ICH-1FH的四个字节，确定文件数据的大小。

- (5)遍历该目录项集合的所有正常文件的目录项，记录每个目录项中偏移为14H-15H处的值，并找出出现频次最高的值，把该值作为起始簇号的高位字。

- (6)根据确定的起始簇号和文件大小，找到文件数据的起始簇，并读取数据，直到所读取数据大小等于文件大小时为止。

- (7)保存数据，并重命名文件。

- (8)如果得到的文件不是我们想要的原文件，则需从(5)中记录的起始簇号高位字的集合中选择另一个出现频次较高的值作为该文件起始簇号的高位字，重复步骤(6)(7)，直到恢复出原文件或遍历完高位字集合为止。如果遍历完(5)中的高位字集合还未恢复出原文件，则需遍历0000H-FFFFH的值并作为该文件起始簇号的高位字，重复步骤(6)(7)，直到恢复出原文件或遍历结束为止。

 

## 3.2基于数据簇非连续分配的文件恢复算法

算法步骤如下：

- (1)-(5)同3.2中的步骤(1)-(5)。

- (6)由文件数据占用簇数N=文件数据大小/(每簇扇区数×每扇区字节数)，计算出文件数据占用簇数N。

- (7)根据(5)中确定的起始簇号，由FAT表项偏移量 = 簇号×4，确定起始簇号对应的FAT表项。

- (8)对起始簇号对应的FAT表项及其后面的每一个表项进行如下判断：若表项值为00000000H，则由簇号=FAT表项偏移量/4，计算并记录该FAT表项对应的簇号，否则跳过该表项，继续进行下一个FAT表项的判断。直到记录的簇号数为N时停止。

- (9)遍历(8)中已经记录下的簇号，读取每个簇号相应簇中的数据，直到所读取数据总大小等于文件大小时为止。 

- (10)保存数据，重命名文件。

- (11)如果得到的文件不是我们想要的原文件，则需从(5)中记录的起 始簇号高位字的集合中选择另一个出观频次较高的值作为该文件起始簇号的高位字，重复步骤(6)(7)(8)(9)(10)，直到恢复出原文件或遍历完高位字集合为止。如果遍历完(5)中的高位字集合还未恢复出原文件，则需遍历0000H-FFFFH的值并作为该文件起始簇号的高位字，重复步骤(6)(7)(8)(9)直到恢复出原文件或遍历结束为止。

