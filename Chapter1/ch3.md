# 第3节：文件恢复原理

  根据文件彻底删除的原理，我们可以知道文件的数据如果未被覆盖，则文件的数据还存在于数据区中。因此，要想把这些数据恢复出来．重建我们的文件，则需要首先找到这些数据的入口在哪里，即找到数据的起始簇号。

  如果该文件的起始簇号小于两个字节所能表示的最大值65535，则用目录项中偏移为1AH-1BH处的低位字即可存储该起始簇号值。这种情况下，删除文件时，就不存在起始簇号高字被清零的问题，我们可以直接从目录项中偏移为1AH-IBH处找到文件数据的起始簇号。但如果起始簇号超出了低位字所能表示的最大值，则需要用目录项中偏移为14H-15H处的高位字来存储其值。这样，删除文件时，起始簇号的两个高字节就会被清零，仅保留了两个低字节。这种情况下，我们要想得到起始簇号的两个高字节，就需要参照创建时间值与之接近的其他正常文件的起始簇号来确定两个高字节。实际进行恢复时，我们可以根据该文件目录项前后的正常文件的目录项中的偏移为14H-15H处的值来判断起始簇号的两个高字节值。

  其次，我们还需要知道文件数据存放在其余哪些簇上。在此之前，我们需要先了解一下Windows操作系统的簇的分配策略。Windows操作系统对文件分配簇时，采用下一可用分配策略。即为一个文件分配了一个簇后，直接由此簇位置向后搜索下一个可用簇，继续为其分配，而不会从文件系统的开始处进行重新搜索。基于这个分配策略，一个文件的数据存储有三种可能的情况：
![1.3.1](../IMG/1.3.1.PNG)

  图2中显示了三种不同的文件数据存储情况。淡灰色方框表示分配给这个文件使用的簇，深灰色方框表示分配给其他文件使用的簇，白色方框表示未分配的空簇。A图表示这个文件数据只占用了一个簇。B图表示这个文件占用了4个簇，簇号为5、6、7、8，而且系统给这个文件分配的这四个簇是连续的。c图表示这个文件数据占用了4个簇，簇号为5、7、8、10，但系统给这个文件分配的这四个簇是非连续的。

  对于A图所示情况，恢复时，只需在确定起始簇号后，对起始簇中的相应文件大小的数据进行提取即可恢复文件。对于B图情况，恢复时，在确定起始簇号后，从起始簇开始，一直向后提取数据，直到提取出的数据大小等于文件大小时为止，这样就恢复出了原文件的数据。

  对于C图情况，该文件数据是非连续存放的。删除文件后，簇5、7、8、10所对应的FAT表项值为“00000000H”。此时，如果簇6,9所对应的文件未被删除，则6,9所对应的FAT表项值为有效值00000001H～ 0FFFFFFFH。这样，恢复时，先由目录项中的文件大小计算出所对应的簇数。在确定起始簇号后，就可以从起始簇号对应的FAT表项开始向后搜索，记录下FAT表项值为“00000000H”的所对应的簇号。当记录下的簇号数等于文件大小所对应的簇数时，停止搜索。然后根据记录下的簇号，提取出对应簇中的数据，直到提取出的数据大小等于文件大小时为止，这样就恢复出了原文件的数据。

  根据B图和c图情况下的数据恢复原理，提出以下基于数据簇连续分配的文件恢复算法和基于数据簇非连续分配的文件恢复算法。

